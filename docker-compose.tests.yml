services:
  newman:
    image: postman/newman:alpine
    container_name: fitness-newman
    depends_on:
      - app
    working_dir: /etc/newman
    # Run a shell script via entrypoint to avoid command tokenization issues
    entrypoint:
      - sh
      - -lc
      - |
        echo 'Waiting for app to be healthy...';
        for i in `seq 1 60`; do
          wget -qO- http://app:8080/actuator/health >/dev/null 2>&1 && break; sleep 2;
        done;
        echo 'Running Newman tests...';
        # Ensure HTML reporter is available in the container
        npm -g ls newman-reporter-html >/dev/null 2>&1 || npm -g i newman-reporter-html;
        newman run postman/fitness-api-tests.postman_collection.json \
          -e postman/fitness-api-tests.postman_environment.json \
          --env-var baseUrl=http://app:8080 \
          --reporters cli,html \
          --reporter-html-export postman/postman-report.html
    volumes:
      - ./:/etc/newman

  unit-tests:
    image: maven:3.9-eclipse-temurin-17
    container_name: fitness-unit-tests
    working_dir: /workspace
    command: mvn -q -e clean test
    volumes:
      - ./:/workspace
      - maven-cache:/root/.m2

volumes:
  maven-cache:
